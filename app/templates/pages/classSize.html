{% extends 'pages/base.html' %} {% block title %}Sĩ số lớp{% endblock %} {%
block content %}
<!-- Bộ lọc chọn lớp -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div
      class="d-flex flex-wrap gap-2 align-items-center justify-content-between"
    >
      <h5 class="mb-0">
        <i class="fa-solid fa-filter icon me-2"></i>Lọc theo lớp
      </h5>
      <div class="d-flex gap-2">
        <!-- Dropdown chọn lớp -->
        <div class="btn-group">
          <button
            class="btn btn-outline-secondary btn-sm dropdown-toggle"
            type="button"
            id="classroomFilterBtn"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            Tất cả các lớp
          </button>
          <ul class="dropdown-menu" id="classroomFilterMenu">
            <li>
              <a
                class="dropdown-item active"
                href="#"
                data-classroom-id="all"
                data-classroom-name="Tất cả các lớp"
              >
                <i class="fa-solid fa-check me-2"></i>Tất cả các lớp
              </a>
            </li>
            {% if classrooms %} {% for classroom in classrooms %}
            <li>
              <a
                class="dropdown-item"
                href="#"
                data-classroom-id="{{ classroom.id }}"
                data-classroom-name="{{ classroom.name }}"
              >
                {{ classroom.name }}
              </a>
            </li>
            {% endfor %} {% endif %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Thống kê sĩ số các lớp -->
<div class="row g-3 mb-4">
  {% if classrooms %} {% for classroom in classrooms %}
  <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
    <!-- ✅ ADDED: class="classroom-card" + data-class-id/data-class-name để click lấy nhiệt độ -->
    <div
      class="card shadow-sm border-0 h-100 classroom-card"
      role="button"
      style="cursor: pointer"
      data-class-id="{{ classroom.id }}"
      data-class-name="{{ classroom.name }}"
    >
      <div class="card-body">
        <div class="d-flex align-items-center gap-3">
          <div class="rounded-3 p-3 bg-light">
            <i class="fa-solid fa-users icon"></i>
          </div>
          <div class="flex-grow-1">
            <div class="text-secondary small mb-1">{{ classroom.name }}</div>
            <div class="fw-bold fs-5">
              <span id="current-{{ classroom.id }}">
                {{ classroom_student_count.get(classroom.id) }}
              </span>
              /
              <span class="text-muted">{{ classroom.max_slots }}</span>
            </div>
            <div class="progress mt-2" style="height: 6px">
              <div
                class="progress-bar"
                role="progressbar"
                id="progress-{{ classroom.id }}"
                style="width: {{ (classroom_student_count.get(classroom.id) / classroom.max_slots * 100) | round(0) }}%"
                aria-valuenow="{{ classroom_student_count.get(classroom.id) }}"
                aria-valuemin="0"
                aria-valuemax="{{ classroom.max_slots }}"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %} {% endif %}
</div>



<!-- Biểu đồ và thống kê -->
<div class="row g-3 mb-4">
  <!-- Biểu đồ giới tính -->
  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-4">
          <i class="fa-solid fa-chart-pie icon me-2"></i>Biểu đồ phân bố giới
          tính
        </h5>
        <div class="position-relative" style="height: 400px">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Thống kê tổng quan -->
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-4">
          <i class="fa-solid fa-chart-bar icon me-2"></i>Thống kê tổng quan
        </h5>
        <div class="d-flex flex-column gap-3">
          <div
            class="d-flex align-items-center justify-content-between p-3 bg-light rounded"
          >
            <div>
              <div class="text-secondary small">Tổng số học sinh</div>
              <div class="fw-bold fs-4" id="total-students">
                {{total_students}}
              </div>
            </div>
            <div class="rounded-circle bg-primary bg-opacity-10 p-3">
              <i class="fa-solid fa-users icon fs-4"></i>
            </div>
          </div>
          <div
            class="d-flex align-items-center justify-content-between p-3 bg-light rounded"
          >
            <div>
              <div class="text-secondary small">Tổng sức chứa</div>
              <div class="fw-bold fs-4" id="total-capacity">{{capacity}}</div>
            </div>
            <div class="rounded-circle bg-info bg-opacity-10 p-3">
              <i class="fa-solid fa-door-open icon fs-4"></i>
            </div>
          </div>
          <div
            class="d-flex align-items-center justify-content-between p-3 bg-light rounded"
          >
            <div>
              <div class="text-secondary small">Tỷ lệ sử dụng</div>
              <div class="fw-bold fs-4" id="usage-rate">
                {{ (total_students / capacity * 100) | round(0) }}%
              </div>
            </div>
            <div class="rounded-circle bg-success bg-opacity-10 p-3">
              <i class="fa-solid fa-gauge-high icon fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--dropdown-->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const menu = document.getElementById("classroomFilterMenu");
    const button = document.getElementById("classroomFilterBtn");
    const cards = document.querySelectorAll(
      ".col-12.col-sm-6.col-lg-4.col-xl-3"
    );

    menu.addEventListener("click", (event) => {
      const item = event.target.closest("a");
      if (!item) return;

      const classroomId = item.dataset.classroomId;
      const classroomName = item.dataset.classroomName;

      button.innerText = classroomName;

      menu
        .querySelectorAll(".dropdown-item")
        .forEach((a) => a.classList.remove("active"));
      item.classList.add("active");

      cards.forEach((card) => {
        const cardClassId = card
          .querySelector("[id^='current-']")
          ?.id.replace("current-", "");

        if (classroomId === "all" || cardClassId === classroomId) {
          card.style.display = "";
        } else {
          card.style.display = "none";
        }
      });

      // Cập nhật biểu đồ giới tính
      if (genderChart) {
        let male = {{ male_count }};
        let female = {{ female_count }};

        if (classroomId !== "all") {
          const stats = genderStatsByClass[classroomId];
          if (stats) {
            male = stats.male;
            female = stats.female;
          } else {
            male = 0;
            female = 0;
          }
        }

        genderChart.data.datasets[0].data = [male, female];
        genderChart.update();
      }
    });
  });
</script>

<script>
  const genderStatsByClass = {{ get_gender_stats_by_class | tojson }};
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  let genderChart = null;
  const ctx = document.getElementById("genderChart");

  if (ctx) {
    genderChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["Nam", "Nữ"],
        datasets: [
          {
            data: [{{ male_count }}, {{ female_count }}],
            backgroundColor: [
              "rgba(54, 162, 235, 0.8)",
              "rgba(255, 99, 132, 0.8)",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      },
    });
  }
</script>

<!-- ✅ ADDED: JS click card lớp -> gọi API /api/classes/<id>/temperatures -> render bảng -->
<script>
  let currentClassId = null;
  const FEVER_TEMP = 38.0; // >= 38 là sốt

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  function renderTempTable(data) {
    const tbody = document.getElementById("temp-tbody");
    tbody.innerHTML = "";

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">Không có dữ liệu</td></tr>`;
      return;
    }

    for (const row of data) {
      const temp = row.temperature;

      let label = "Chưa đo";
      let badge = "text-bg-secondary";
      let dot = "bg-secondary";

      if (temp !== null && temp !== undefined) {
        if (Number(temp) >= FEVER_TEMP) {
          label = "Sốt";
          badge = "text-bg-danger";
          dot = "bg-danger";
        } else {
          label = "Bình thường";
          badge = "text-bg-success";
          dot = "bg-success";
        }
      }

      tbody.insertAdjacentHTML(
        "beforeend",
        `
        <tr>
          <td>${row.student_name}</td>
          <td class="text-end">${temp ?? "-"}</td>
          <td class="text-center"><span class="badge ${badge}">${label}</span></td>
        </tr>
      `
      );
    }
  }

  async function loadClassTemps() {
    if (!currentClassId) return;
    const date = document.getElementById("temp-date").value;

    const url = date
      ? `/api/classes/${currentClassId}/temperatures?date=${date}`
      : `/api/classes/${currentClassId}/temperatures`;

    const data = await fetchJson(url);
    renderTempTable(data);
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".classroom-card").forEach((card) => {
      card.addEventListener("click", async () => {
        currentClassId = card.dataset.classId;
        document.getElementById("temp-class-name").textContent =
          card.dataset.className || ("#" + currentClassId);
        await loadClassTemps();
      });
    });

    document.getElementById("temp-date").addEventListener("change", loadClassTemps);
    document.getElementById("temp-refresh").addEventListener("click", loadClassTemps);
  });
</script>

{% endblock %}
